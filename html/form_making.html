<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>기사단 편성 작동</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">  
    <link href="./css/main.css" rel="stylesheet">
    <link href="./css/form_share.css" rel="stylesheet">
    <link href="./css/lv_badges.css" rel="stylesheet">
    <link href="./css/form_making.css" rel="stylesheet">
</head>
<body>
    <div class="share-card shadow-basic">
        <!-- 상단바 -->
        <div class="post-title title-size ">
            <dix class="share-or-ask ">
                <button type="button " class="share-or-ask-btn btn-blue title-sizing color-white border-0 d-flex align-items-center justify-content-center"><i class="fa-solid fa-angle-down"></i><p>&nbsp; 편성 공유</p></button>
                <div class="share-or-ask-menu">
                    <!-- <button class="share-or-ask-btn btn-blue title-sizing color-white border-0 d-flex align-items-center justify-content-center form-stat-selected">편성 공유</button> -->
                    <button class="share-or-ask-btn btn-yellow title-sizing color-white border-0 d-flex align-items-center justify-content-center">편성 요청</button>
                    <button class="share-or-ask-btn btn-purple title-sizing color-white border-0 d-flex align-items-center justify-content-center">편성 저장</button>
                    <button class="share-or-ask-btn btn-green title-sizing color-white border-0 d-flex align-items-center justify-content-center">편성 완료</button>
                </div>
            </dix>

            <button type="button"  class="btn-black flex-fill title-sizing color-yellow border-0 d-flex align-items-center"><i class="fa-solid fa-angle-down"></i><p>&nbsp; 아레나</p></button>
            <button type="button" class="bg-red btn-close-origin color-white" ><i class="fa-solid fa-xmark"></i></button>
        </div>

        <!-- 컨텐츠 -->
        <div class="d-flex justify-content-center">

            <!-- 왼쪽 -->
            <div class="left-box">
                <!-- 작성자정보 -->
                <div class="d-flex mg-10px ">
                    <p class="t-pd color-white bg-basicdark">작성자</p>
                    <p class="t-pd color-writer bg-basicdark">여덟글자정도어때</p>
                </div>

                <!-- 조합들 들어간 칸 -->
                <div class="content-h d-flex justify-content-center align-items-center">
                    <div class="d-flex flex-wrap justify-content-center c-wrapper width-5">
                        <div class="character-5 form_spot">
                                                     
                            <div class="select-liner">
                                <div class="empty"><i class="fa-solid fa-plus color-gray"></i> </div>
                            </div>
                        </div>
                        <div class="character-5 form_spot">
                            <div class="select-liner ">
                                <div class="empty"><i class="fa-solid fa-plus color-gray"></i> </div>
                            </div>
                        </div>
                        <div class="character-5 form_spot">
                            <div class="select-liner">
                                <div class="empty"><i class="fa-solid fa-plus color-gray"></i> </div>
                            </div>
                        </div>
                        <div class="character-5 form_spot">
                            <div class="select-liner">
                                <div class="empty"><i class="fa-solid fa-plus color-gray"></i> </div>
                            </div>
                        </div>
                        <div class="character-5 form_spot">
                            <div class="select-liner">
                                <div class="empty"><i class="fa-solid fa-plus color-gray"></i> </div>
                            </div>
                        </div>
                        
                    </div>

                </div>

                <!-- 하단 버튼 -->
                <div class="charSetting-container d-flex justify-content-center align-self-center">
                    <form action=""><label class="charSetting-ele d-flex align-self-center"> <span class="me-2">나의 영웅들 공개하기</span> <input type="checkbox" name="character_public" class="charPublic-checkbox"><span class="checkbox-img"></span>  </label></form>
                    
                    <div style="width: 148.5px;">
                    <div class="btn-shadow">
                        <button class="charSetting-btn charSetting-ele  btn-cut btn-white">  영웅 설정 <i class="fa-solid fa-user-gear"></i> </button>
                    </div>
                    </div>
                </div>
            </div>

            <!-- 오른쪽 : 작성자 한마디 + 좋아요 / 댓글 펼치기 -->
            <div class="right-box right-box-mg">
                <h6 class="explain-title ">작성자 한마디</h6>
                <div class="bg-white content-h mt-1 color-gray">
                    <form>
                        <textarea class="memo explain-content" placeholder="한마디를 적어주세요" ></textarea>
                    </form>
                </div>

                <!-- 좋아요 / 댓글 펼치기 -->
                <div class="mg-10px ms-0 me-0 d-flex flex-fill justify-content-between">
                    <div class="btn-shadow d-flex justify-content-start">
                        <button class="btn-cut bottom-btn btn-blue color-white">불러오기 </button>
                    </div>
                    <div class="btn-shadow d-flex justify-content-end">
                        <button class="btn-cut bottom-btn btn-yellow color-white">저장/게시 </button>
                    </div>
                </div>
            </div>
        </div>
        
    </div>

    <!-- 캐릭터가 떠있는 창 -->
    <div class="characters-spread shadow-basic" >
        <div class="characters-container d-flex justify-content-start flex-wrap">
            <div class="character-list-box select-liner d-flex justify-content-center">
                <div class="character-list">
                    <img src="../sources/img/characters/dark_zhurahan.png">
                    <span class="lv_dark ">70</span>
                    <span class="nogak ">7</span>
                </div>
            </div>
            <div class="character-list-box select-liner d-flex justify-content-center">
                <div class="character-list ">
                    <img src="../sources/img/characters/fire_meiling.png">
                    <span class="lv_fire ">70</span>
                    <span class="nogak ">7</span>
                </div>
            </div>
            <div class="character-list-box select-liner d-flex justify-content-center">
                <div class="character-list">
                    <img src="../sources/img/characters/grass_rairei.png">
                    <span class="lv_grass ">70</span>
                    <span class="onegak ">7</span>
                </div>
            </div>
            <div class="character-list-box select-liner d-flex justify-content-center">
                <div class="character-list">
                    <img src="../sources/img/characters/grass_raligon.png">
                    <span class="lv_grass ">70</span>
                    <span class="twogak ">7</span>
                </div>
            </div>
            <div class="character-list-box select-liner d-flex justify-content-center">
                <div class="character-list">
                    <img src="../sources/img/characters/light_charlotte.png">
                    <span class="lv_light ">70</span>
                    <span class="twogak ">7</span>
                </div>
            </div>
            <div class="character-list-box select-liner d-flex justify-content-center">
                <div class="character-list">
                    <img src="../sources/img/characters/water_rosanna.png">
                    <span class="lv_water ">70</span>
                    <span class="twogak ">7</span>
                </div>
            </div>
            
        </div>
        
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script>

        /***
         * 칸 클릭하면 다른 칸 선택 지워지고 클릭한 칸 선택됨
         ***/
        $(".form_spot").on('click', function(e){

            if ($(e.target).hasClass("out")) return;

            let spot = $(this);
            
            $(".form_spot .spot-selected-empty").remove();
            $(".form_spot .spot-selected-full").remove();
            $(".form_spot .out").remove();
            if(spot.find(".empty").length>0){
                spot.prepend("<div class='spot-selected-empty'></div>");
            }else {
                spot.prepend('<img src="../sources/img/out_char.png" class="out">');
                spot.prepend("<div class='spot-selected-full'></div>");                   
            }
        })

        /***
         * o = 도착지
         * t = 클릭한 캐릭터
         ***/
        function putCharInForm(o, t){
            o.siblings(".select-liner").children().remove();
            
            t.find(".char-selected").remove();

            t.children().clone().appendTo(o.siblings(".select-liner"));
            o.parent().append('<img src="../sources/img/out_char.png" class="out">');
            o.attr('class', 'spot-selected-full');

            t.prepend("<div class='char-selected'></div>");
        }

        
        $(".character-list").on('click', function(e){
            /***
            * 캐릭터 클릭했을 때 칸 선택되어 있으면 거기로 들어감
            ***/
           //빈 칸인지 이미 누군가 있는지 확인
            if($(".spot-selected-empty").length>0){
                //클릭한 캐릭터가 다른 곳에 있으면 거길 삭제
                let clicked_img = $(this).children('img');
                let existed_img = $(".form_spot img[src$='"+ clicked_img.attr('src') +"']")
                if(existed_img.length>0){
                    let ex_parent = existed_img.eq(0).parent();
                    console.log(ex_parent);
                    ex_parent.children().remove();
                    ex_parent.append('<div class="empty"><i class="fa-solid fa-plus color-gray"></i> </div>');
                }

                putCharInForm($(".spot-selected-empty"), $(this));
                return false;
            } else if($(".spot-selected-full").length>0){

                
                let clicked_img = $(this).children('img');
                let selected_img = $(".spot-selected-full").siblings(".select-liner").children("img");
                let existed_img = $(".form_spot img[src$='"+ clicked_img.attr('src') +"']")
     
                //클릭한 캐릭터가 다른 곳에 있고 클릭한 캐릭터와 선택된 칸의 캐릭터가 다르면
                //원래 이 칸에 있던 이미지를 거기로 보내고 이 칸에 클릭한 캐릭터를 채운다.
                if(existed_img.length>0 && clicked_img.attr('src') !== selected_img.attr('src')){
                    let ex_parent = existed_img.parent()
                    ex_parent.children().remove();
                    selected_img.parent().children().appendTo(ex_parent);

                    putCharInForm($(".spot-selected-full"), $(this));
                    return false;
                }
                
                //selected에 원래 있던 애를 캐릭터 칸에서 찾아서 selected div 삭제한다.
                let same = $(".character-list img[src$='"+ selected_img.attr('src') +"']").eq(0).parent();
                same.find('.char-selected').remove();

                if(clicked_img.attr('src') !== selected_img.attr('src')){  
                    //다른 캐릭터를 눌렀다면 
                    putCharInForm($(".spot-selected-full"), $(this));
                    return false;
                } else{
                    //같은 캐릭터를 눌렀다면 삭제한다.
                    selected_img.parent().children().remove();
                    $(".spot-selected-full").siblings(".out").remove();
                    $(".spot-selected-full").siblings(".select-liner").append('<div class="empty"><i class="fa-solid fa-plus color-gray"></i> </div>');
                    $(".spot-selected-full").attr('class', 'spot-selected-empty');

                }

                

                return false;
                
            }

            /***
            * 캐릭터 클릭했을 때 이미 들어가있으면 삭제됨
            ***/
            // let src = $(this).children().eq(1).attr("src");
            // let same = $(".form_spot img[src$='"+ src +"']").eq(0).parent();

            // same.children().remove();
            // same.append('<div class="empty"><i class="fa-solid fa-plus color-gray"></i> </div>');
            // $(this).find(".char-selected").remove();
            


        })

        /***
         * 마이너스 클릭하면 캐릭터 지워짐
         ***/
        $(document).on("click", ".out", function(e){
            e.stopPropagation();
            e.preventDefault();
            
            // 폼 칸에서 캐릭터 이미지를 삭제하고 빈 칸으로 전환
            let this_character = $(this).siblings(".select-liner");
            let character_src = $(this).siblings(".select-liner").children("img").attr('src');
            let chararcter = $(".character-list img[src$='"+ character_src +"']")

            // console.log(chararcter);

            this_character.children().remove();
            $(".spot-selected-full").siblings(".out").remove();
            this_character.append('<div class="empty"><i class="fa-solid fa-plus color-gray"></i> </div>');

            // 폼 칸의 선택된 효과를 빈 칸으로 전환
            $(".spot-selected-full").attr('class', 'spot-selected-empty');

            // 해당 캐릭터와 동일한 얼굴을 아래에서 찾아서 선택 해제
            chararcter.siblings(".char-selected").remove();
            
            
        })


        


        /***
         * 빈 곳 클릭하면 칸 선택 해제
         ***/
        $(document).on('click', function(e){
            if (!$(e.target).closest(".form_spot").length>0 
            && !$(e.target).closest(".character-list").length>0
            && !$(e.target).closest(".out").length>0) {
                // console.log($(e.target).closest(".form_spot"))
                $(".spot-selected-empty").remove();
                $(".spot-selected-full").siblings(".out").remove();
                $(".spot-selected-full").remove();     
                
                // console.log(e.target)
            }

            // 드롭다운 올라가게
            if(!$(e.target).closest(".share-or-ask-btn").length>0){
                $(".share-or-ask-menu").slideUp(150);
                $(".share-or-ask-menu").siblings("button").children("i").attr('class', "fa-solid fa-angle-down");
            }
            

        })



      
        
        $(document).ready(function(){
            
            const originalButtons = $(".share-or-ask button").map(function () {

                let text = $(this).text().replace(/\u00A0 /g, '');

                return {
                text: text,
                class_names: $(this).attr('class')
                };
            }).get();
            
            let current_selection = "편성 공유";

            /**
             * 편성 상태 드롭다운 바꾸기
             **/
            $(".share-or-ask").on('click', ".share-or-ask-btn" , function(e){
            const menu =  $(".share-or-ask-menu");
            const top_btn = menu.siblings("button");
            const now_class = $(this).attr('class');

            // console.log(originalButtons)        

            if(now_class != top_btn.attr('class')){

                current_selection = $(this).text();

                top_btn.attr('class', now_class);
                top_btn.children("p").html("&nbsp; " + $(this).text())
                renderMunu();
                
            }

            formStatToggle();
            });

            function renderMunu(){
                $(".share-or-ask-menu").empty();
                originalButtons.forEach(item => {
                    // console.log("item.text : " + item.text)
                    // console.log("current_selection : " + current_selection)
                    if (item.text != current_selection) {
                        $(".share-or-ask-menu").append(`<button class="${item.class_names}">${item.text}</button>`);
                    }
                });
            }

            /**
             * 드롭다운 토글 함수
             **/
            function formStatToggle(){
                const menu =  $(".share-or-ask-menu");
                const top_btn = menu.siblings("button");
                const now_i = top_btn.children("i");
                const now_class = $(this).attr('class');

                menu.slideToggle(150);

                if(now_i.attr('class') == "fa-solid fa-angle-down"){
                    now_i.attr('class', "fa-solid fa-angle-up");
                } else {
                    now_i.attr('class', "fa-solid fa-angle-down");
                }
            }
        })
        


    </script>

</body>
</html>