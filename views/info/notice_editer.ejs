<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로드의 전술서:공지사항 에디터</title>
    <link href="/sources/img/로전아이콘.svg" rel="shortcut icon" type="image/x-icon">

    <!-- include libraries(jQuery, bootstrap) -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <!-- include summernote css/js -->
    <link href="https://cdn.jsdelivr.net/npm/summernote@0.9.0/dist/summernote.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.9.0/dist/summernote.min.js"></script>

    <link href="/css/main.css" rel="stylesheet">

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8925406073494167"
     crossorigin="anonymous"></script>
</head>
<body>
    <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; ">
        <div>
            <h3>공지 작성</h3>
            <label style="display: flex; margin-bottom: 20px;">
                <h4>상단 고정</h4>                    
                <input type="checkbox" <% if(data.pin && data.pin == true) {%> checked <% } %> name="pin" >
            </label>
            <h4 style="margin-bottom: 8px;">제목</h4>
            <input type="text" name="subject" placeholder="제목 입력" <% if(data.subject) {%> value="<%= data.subject %>" <% } %> class="input-box" style=" margin-bottom: 10px; width: 1400px; " >
        </div>

        <form method="post"  class="summernote-form" style="position: relative;">
            <input type="submit" value="작성완료" class="submit-notice btn-blue color-white btn-cut" style="border: none; padding: 8px 15px; margin-bottom: 10px; position: absolute; right: 20px; top: 3px; z-index: 2;">
            <textarea id="summernote" name="editordata"><% if(data.content) {%> <%- data.content %> <% } %></textarea>
        </form>
    </div>

    <script>
        let imgs = "";
        $(".summernote-form").on("submit", function(e){
            e.preventDefault();
            $(window).unbind('beforeunload');

            if(confirm("이대로 공지사항을 게시할까요?")){
                let form = $("<form></form>")
                form.attr("method","post");

                if(parseInt(window.location.href.split('/').pop())){
                    form.attr("action","/info/editnotice/" + window.location.href.split('/').pop());
                } else{
                    form.attr("action","/info/writeNewNotice");
                }
                
                let html_imgs = $('img').map(function(){
                    return $(this).data('key');
                }).get();

                html_imgs.forEach(function(element){
                    form.append(`<input name='html_imgs' type='hidden' value='${element}'>`);
                })
                form.append(`<input name='pin' type='hidden' value='${$("input[name='pin']").prop("checked") == true}'>`);
                form.append(`<input name='subject' type='hidden' value='${$("input[name='subject']").val()}'>`);
                form.append(`<input name='aws_imgs' type='hidden' value='${imgs}'>`);
                form.append(`<textarea name='content' type='hidden'>${$('#summernote').summernote('code')}</textarea>`)
                
                form.appendTo("body");

                form.submit();
            }
            
        })

        $(document).ready(function() {
            $('#summernote').summernote({
                placeholder: '공지 내용 입력',
                height: 500,
                width: 1400,
                callbacks:{
                    onImageUpload: function(files){
                        sendFile(files[0], this);
                    }
                }
            });

            $(window).bind('beforeunload',  
                function (e) {  
                $.ajax({
                    url : "/info/deleteImage/all",
                    data : {imgs : imgs},
                    method : "POST",
                    success(data){
                        console.log(data);
                    },
                    error : console.log
                });
                return "변경 사항을 저장하지 않을 수 있습니다. 정말로 이 페이지를 떠나시겠습니까?";
            });
        });

        function sendFile(file, editor){
            data = new FormData()
            data.append("img", file)
            // id 'img'로 file form 데이터 추가
            $.ajax({
                data: data,
                type: "POST",
                // 이미지 처리를 할 url
                url: "/info/insertImage",
                cache: false,
                contentType: false,
                // multer-s3를 활용하므로 multipart/form-data형태로 넘겨줘야 한다.
                enctype: "multipart/form-data",
                processData: false,
                success: function (res) {
                var imgurl = $('<img>').attr({
                    'src': res.imgurl,
                    'data-key' : res.imgkey,
                });
                
                imgs += '/' + res.imgkey;
                // console.log(imgurl);
                $("#summernote").summernote("insertNode", imgurl[0]);
                // insertNode는 html tag를 summernote 내부에 삽입해주는 기능.
                },
            })
        }
    </script>

</body>
</html>