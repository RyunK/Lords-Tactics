<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로드의 전술서:이용 안내</title>
    <link href="/sources/img/로전아이콘.svg" rel="shortcut icon" type="image/x-icon">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="/css/main.css" rel="stylesheet">
    <link href="/css/instruction.css" rel="stylesheet">

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8925406073494167"
     crossorigin="anonymous"></script>
</head>
<body>
    
    <%- include('../nav_and_banner.ejs', {page: 'notice', nickname: data.nickname, notice:data.banner_notice }) %> 
    
    <div class="mt-5 mb-4  d-flex flex-wrap flex-column justify-content-center align-items-center">

    <h2 class="text-center">수정 중</h2>
    <a href="#" class="admin-noticewrite submit-qna btn-cut btn-blue color-white" style="position: static; ">완료</a>
    <a href="#" class="admin-noticewrite add-qna mt-3 btn-cut btn-yellow color-white" style="position: static; ">질문 추가</a>
    </div>    
    
    <form class="instruction-contents" action="/info/faq/edit/save" method="post">
        <ul class="notice-container faq-container faq-editor shadow-basic">
            <li class="top"></li>

            <% for(let i=0; i<data.faqs.length; i++) {%>
            <li class="border">
                <div class="d-flex bg-gray">
                    (아래 질문 정보에 해당)
                    <div class="ms-3">ID : <input type="text" readonly name="id" value="<%= data.faqs[i].id %>" class="bg-gray color-gray"></div>
                    <div class="ms-2">순서 : <input type="text" readonly name="order_num" value="<%= data.faqs[i].order_num %>" class="bg-gray color-gray"></div>
                    <button type="button" class="btn-up ms-2 btn-purple color-white border-0">⬆️ 한 칸 위로</button>
                    <button type="button" class="btn-down ms-2 btn-purple color-white border-0">⬇️ 한 칸 아래로</button>
                    <button type="button" class="btn-delete ms-2 btn-red color-white border-0">삭제</button>
                </div>
                <div class="instruction-post">
                    <span ><i class="fa-solid fa-q"></i></span>
                    <textarea placeholder="질문 내용 입력" name="question" class="faq-edit-textarea flex-fill" ><%= data.faqs[i].question %></textarea>
                    <span><i class="fa-solid fa-chevron-down"></i></span> 
                </div>
                <div class="answer-post bg-basicdark">
                    <span class="color-blue"><i class="fa-solid fa-a"></i></span>
                    <textarea placeholder="대답 내용 입력" name="answer" class="faq-edit-textarea flex-fill color-white" ><%= data.faqs[i].answer %></textarea>
                </div>
            </li>
            <% } %>    

            
        </ul>
    </form>


    
    <%- include('../footer.ejs') %> 
        

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    
    <script>
        function moveToPageNum(num){
            // console.log($(page).text())
            url = new URL(window.location.href);
            url.searchParams.set("p", num);
            window.location.href = url.toString();
        }
        
        $(document).on("click", ".faq-container .instruction-post", function(){
            // console.log("sdfas")
            if($(this).siblings(".answer-post").css("height") == '0px'){
                $(".faq-container .answer-post").css("height", "0").css("padding", "0 60px")
                $(".faq-container .instruction-post .fa-chevron-up").removeClass("fa-chevron-up").addClass("fa-chevron-down").removeClass("color-blue")
                $(this).siblings(".answer-post").css("height", "auto").css("padding", "30px 60px")
                $(this).children('span').eq(1).children("i").removeClass("fa-chevron-down").addClass("fa-chevron-up").addClass("color-blue")
            } else{
                $(".faq-container .answer-post").css("height", "0").css("padding", "0 60px")
                $(this).children('span').eq(1).children("i").removeClass("fa-chevron-up").addClass("fa-chevron-down").removeClass("color-blue")
            }

        })

        $(".add-qna").on("click", function(e){
            e.preventDefault()
            // 밑에다 하나 붙여주기
            let row_num = $("input[name='order_num']").last().val();

		if(!parseInt(row_num)) row_num = 0;

            row_num = parseInt(row_num) + 1

            let qna = `
            <li class="border">
                <div class="d-flex bg-gray">
                    (아래 질문 정보에 해당)
                    <div class="ms-3">ID : <input type="text" readonly name="id" value="new" class="bg-gray color-gray"></div>
                    <div class="ms-2">순서 : <input type="text" readonly name="order_num" value="${row_num}" class="bg-gray color-gray"></div>
                    <button type="button" class="btn-up ms-2 btn-purple color-white border-0">⬆️ 한 칸 위로</button>
                    <button type="button" class="btn-down ms-2 btn-purple color-white border-0">⬇️ 한 칸 아래로</button>
                    <button type="button" class="btn-delete ms-2 btn-red color-white border-0">삭제</button>
                </div>
                <div class="instruction-post">
                    <span ><i class="fa-solid fa-q"></i></span>
                    <textarea placeholder="질문 내용 입력" name="question" class="faq-edit-textarea flex-fill" ></textarea>
                    <span><i class="fa-solid fa-chevron-down"></i></span> 
                </div>
                <div class="answer-post bg-basicdark">
                    <span class="color-blue"><i class="fa-solid fa-a"></i></span>
                    <textarea placeholder="대답 내용 입력" name="answer" class="faq-edit-textarea flex-fill color-white" ></textarea>
                </div>
            </li>`

            $(".instruction-contents .faq-editor").append(qna);
        })  

        // 삭제했을 때, 만약 id가 new면 그냥 ui 삭제
        // id 숫자면 ajax 요청 후 성공시 ui 삭제
        $(document).on("click", ".faq-editor .btn-delete",  function(){

            if(!confirm("항목을 삭제할까요? 되돌릴 수 없으니 주의하세요."))
                return false;

            let id = $(this).siblings("div").eq(0).children("input").val();
            // console.log(id)
            // 이거 아래것들 순서 바꾸기 
            let this_order = $(this).siblings("div").eq(1).children("input").val()
            let order_list = $(".faq-editor input[name='order_num']")

            if(id == "new"){
                for(let i=parseInt(this_order); i<order_list.length; i++){
                    $(order_list[i]).val(i)
                }
                $(this).parent().parent().remove();
            } else{
                $.ajax({
                    url: `/info/faq/edit/delete`, 
                    method: 'POST', 
                    contentType: 'application/json',
                    data: JSON.stringify({ 
                        id : id,
                    }),
                    
                    // 요청 성공 
                    success: function(res) {
                        if(res.status.includes('2')){
                            // 아래 내용들 순서 바꾸기 (this_order 받아와야 할듯)
                            let order_list = $(".faq-editor input[name='order_num']")
                            for(let i=parseInt(res.data.this_order); i<order_list.length; i++){
                                $(order_list[i]).val(i)
                            }

                            // ui 삭제
                            $('.faq-container li').eq(res.data.this_order).remove();

                        } else{
                            // DB 오류
                            alert(res.message);
                        }
                    },                        
                    
                    error: function(xhr, status, error) {
                        // 오류 
                        alert(`오류 발생! 다시 시도하세요. ${status} - ${error}`);
                        console.error('Error:', status, error);
                    }
                })
            }
        })

        // 완료 누르면 제출
        $(".submit-qna").on('click', function(e){
            e.preventDefault();

            if(!confirm("이대로 자주 묻는 질문을 저장할까요?"))
                return false;

            $(".instruction-contents").submit();

        })
        
        // 한 칸 아래로 버튼 누르면 ui 옮기면서 순서 바꾸기
        $(document).on("click", ".btn-down", function(e){
            let this_li = $(this).parent().parent();
            let next_li = this_li.next();
            // console.log(next_li);
            if(next_li.length <= 0) return false;


            let this_order = $(this).siblings("div").eq(1).children("input").val();
            let next_order = next_li.children("div").eq(0).children('div').eq(1).children("input").val()
            $(this).siblings("div").eq(1).children("input").val(next_order);
            next_li.children("div").eq(0).children('div').eq(1).children("input").val(this_order);
            
            next_li.after(this_li);
        })

        // 한 칸 위로 버튼 누르면 ui 옮기면서 순서 바꾸기
        $(document).on("click", ".btn-up", function(e){
            let this_li = $(this).parent().parent();
            let prev_li = this_li.prev();
            // console.log(next_li);
            if(prev_li.length <= 0 || prev_li.children("div").length <= 0) return false;


            let this_order = $(this).siblings("div").eq(1).children("input").val();
            let prev_order = prev_li.children("div").eq(0).children('div').eq(1).children("input").val()
            $(this).siblings("div").eq(1).children("input").val(prev_order);
            prev_li.children("div").eq(0).children('div').eq(1).children("input").val(this_order);
            
            prev_li.before(this_li);
        })

    </script>
    


</body>
</html>
