<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로드의 전술서:마이페이지</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="/css/main.css" rel="stylesheet">
    <link href="/css/mypage.css" rel="stylesheet">
    <link href="/css/lv_badges.css" rel="stylesheet">
    <link href="/css/form_making.css" rel="stylesheet">
    <link href="/css/form_detail.css" rel="stylesheet">
</head>
<body>

    <%- include('../nav_and_banner.ejs', {page: '', nickname: data.nickname, notice:'2025.08.01 신규 캐릭터 [물]라플라스 추가 완료'}) %> 

    <div class="toast-black">
        
    </div>

    <!-- 왼쪽 리모콘(?) -->
    <div class="mypage-remote ">
        <div class="btn-shadow mb-3 d-flex justify-content-end">
            <a class="btn-blue btn-cut go-back">
                <i class="fa-solid fa-chevron-left"></i> <span class="flex-fill text-center">뒤로 가기</span>
            </a>
        </div>
        <%- include('mypage_nav.ejs', {page: 'form save', nickname: data.nickname}) %> 

        <div class="shadow-filter-basic"> 
            <div class="filter-container">
                <div>
                    <h6>편성 공개 여부</h6>
                    <div class="access-container access-disabled d-flex flex-fill justify-content-between ">
                        <label class="charSetting-ele d-flex align-self-center me-3">  
                            <span class="me-2">전체 </span>
                            <input type="radio" name="form_access" value="all" class="charPublic-checkbox " onclick="return false;" <% if(data.form_access == 'all') {%> checked <%}%>  >
                            <span class="checkbox-img"></span> 
                        </label>
                        <label class="charSetting-ele d-flex align-self-center me-3">  
                            <span class="me-2">공개 </span> 
                            <input type="radio" name="form_access" value="public" class="charPublic-checkbox " onclick="return false;" <% if(data.form_access == 'public') {%> checked <%}%> >
                            <span class="checkbox-img"></span> 
                        </label>
                        <label class="charSetting-ele d-flex align-self-center me-3">  
                            <span class="me-2">비공개 </span> 
                            <input type="radio" name="form_access" value="private" class="charPublic-checkbox " onclick="return false;" <% if(data.form_access == 'private') {%> checked <%}%>>
                            <span class="checkbox-img"></span> 
                        </label>
                        
                    </div>
                    
                </div>
                <div>
                    <h6>편성 상태</h6>
                    <div class="disable-div color-black"><%=data.now_formstatus[0].status_name %> </i></div>
                </div>
                <div>
                    <h6>영웅 필터</h6>
                    <div class="disable-div color-gray"> </i></div>
                    <div class="search-hero-container d-inline-block mt-3">
                        <% for(let i=0; i<data.filtered_heroes_list_forrender.length; i++){ %>
                            <div class="search-hero-img d-inline-block">
                                <img src="/sources/img/characters/<%= data.filtered_heroes_list_forrender[i].eng_type %>_<%= data.filtered_heroes_list_forrender[i].eng_name %>_<%= data.filtered_heroes_list_forrender[i].eng_class %>.png" alt="">
                                <span></span>
                                <input type="hidden" name="hero" value="<%= data.filtered_heroes_list_forrender[i]['ID']%>" >
                            </div>    
                        <% } %>
                    </div>
                </div>
                <div>
                    <h6>컨텐츠</h6>
                    <div class="disable-div color-black"><%= data.content[0].kor_name%> </div>
                </div>
                <p class="color-red disable-notice">* 편성 전체 보기에서는 <br> 필터 조작이 불가능합니다.</p>
            </div>
        </div>
    </div>

    <!-- 오른쪽 컨텐츠 -->
    <div class="mypage-maincontents" >
        <!-- 편성 글. 조합 -->
        <div data-id="<%= data.form_info[0].ID%>" class="form-container mypage-form-detail-sizing shadow-basic">
            <!-- 상단바 -->
            <div class="form-title ">
                <dix class="form-status ">
                    <% if(data.form_info[0].STATUS_NAME == "편성 공유" ) { %>
                        <button type="button " class="status-share border-0 d-flex align-items-center justify-content-center">
                    <% } else if(data.form_info[0].STATUS_NAME == "편성 요청" ) {  %>
                        <button type="button " class="status-request border-0 d-flex align-items-center justify-content-center">
                    <% } else if(data.form_info[0].STATUS_NAME == "편성 저장" ) {  %>
                        <button type="button " class="status-save border-0 d-flex align-items-center justify-content-center">
                    <% } else if(data.form_info[0].STATUS_NAME == "편성 도움" ) {  %>
                        <button type="button " class="status-help border-0 d-flex align-items-center justify-content-center">
                    <% } else if(data.form_info[0].STATUS_NAME == "편성 완료" ) {  %>
                        <button type="button " class="status-end border-0 d-flex align-items-center justify-content-center">
                    <% } else { %>
                        <button type="button " class="status-share border-0 d-flex align-items-center justify-content-center">
                    <% } %>        
                        <p><%=data.form_info[0].STATUS_NAME %></p>
                    </button>
                </dix>

                <div class="content-name flex-fill">
                    <button type="button"  class="bg-basicdark  color-yellow border-0 d-flex align-items-center justify-content-between">
                        <p><%=data.form_info[0].CONTENT_NAME %></p>
                        <% if(data.form_info[0].ACCESS == 'private') {%>
                            <i class="ms-3 fa-solid fa-lock"></i>
                            <div class="private-hover-box color-black shadow-basic">
                                <span class="">비공개</span> 편성
                            </div>
                        <% }%>
                    </button>

                </div>
                
            </div>

            <!-- 아래 컨텐츠 -->
            <div class="d-flex contents">
                
                <!-- 왼쪽 -->
                <div class="left-box">
                    <div class="d-flex align-items-end">
                        <div class="form-author bg-basicdark color-white">
                            작성자 <span class="color-purple"><%=data.form_info[0].NICKNAME %></span>
                        </div>
                        <div class="form-detail-date">
                            <%=data.form_info[0].LAST_DATETIME.getFullYear()+"-"+("0"+(data.form_info[0].LAST_DATETIME.getMonth()+1)).slice(-2) + "-" + ("0"+(data.form_info[0].LAST_DATETIME.getDate())).slice(-2) + " " +  ("0"+(data.form_info[0].LAST_DATETIME.getHours())).slice(-2) + ":" +  ("0"+(data.form_info[0].LAST_DATETIME.getMinutes())).slice(-2) %>
                        </div>
                    </div>
                    
 
                    
                    <form class="form-border-container d-flex align-items-center flex-wrap">
                        <% if (data.members.length == 5){ %>
                            <div class="form-char-container w-100 d-flex flex-wrap justify-content-center ">
                                <% for(let i=0; i<data.members.length; i++){ %>
                                    <div class="character-5 form_spot">
                                        <div class="select-liner">
                                            <% if(data.members[i].NAME == 'empty'){ %>
                                                <div class="empty"><i class="fa-solid fa-plus color-gray"></i> </div>
                                            <% } else if(data.members[i].HERO_LV == 0){ %>
                                                <% let gak2eng = {1: "one", 2: "two", 0:"no"} %>
                                                <img src="/sources/img/characters/<%= data.members[i].TYPE%>_<%= data.members[i].NAME%>_<%= data.members[i].CLASS%>.png" class="nothave" onerror="this.onerror=null; this.src='/sources/img/characters/Chr_Error.png';" >
                                                <span class="lv_<%= data.members[i].TYPE%> lv"><%= data.members[i].HERO_LV%></span>
                                                <span class="<%= gak2eng[data.members[i].HERO_GAK]%>gak gak"><%= data.members[i].HERO_CHO%></span>
                                            <% } else{  %>
                                                <% let gak2eng = {1: "one", 2: "two", 0:"no"} %>
                                                <img src="/sources/img/characters/<%= data.members[i].TYPE%>_<%= data.members[i].NAME%>_<%= data.members[i].CLASS%>.png" onerror="this.onerror=null; this.src='/sources/img/characters/Chr_Error.png';" >
                                                <span class="lv_<%= data.members[i].TYPE%> lv"><%= data.members[i].HERO_LV%></span>
                                                <span class="<%= gak2eng[data.members[i].HERO_GAK]%>gak gak"><%= data.members[i].HERO_CHO%></span>
                                            <% } %>
                                        </div>
                                    </div>
                                <% } %>
                            </div>
                        <% } else if  (data.members.length == 10){  %>
                        <h5 class="w-100">1 부대</h5>
                        <div class="form-char-container w-100 d-flex flex-wrap justify-content-center ">
                            <% for(let i=0; i<5; i++){ %>
                                <div class="character-10 form_spot">
                                    <div class="select-liner">
                                        <% if(data.members[i].NAME == 'empty'){ %>
                                            <div class="empty"><i class="fa-solid fa-plus color-gray"></i> </div>
                                        <% } else if(data.members[i].HERO_LV == 0){ %>
                                            <% let gak2eng = {1: "one", 2: "two", 0:"no"} %>
                                            <img src="/sources/img/characters/<%= data.members[i].TYPE%>_<%= data.members[i].NAME%>_<%= data.members[i].CLASS%>.png" class="nothave" onerror="this.onerror=null; this.src='/sources/img/characters/Chr_Error.png';" >
                                            <span class="lv_<%= data.members[i].TYPE%> lv"><%= data.members[i].HERO_LV%></span>
                                            <span class="<%= gak2eng[data.members[i].HERO_GAK]%>gak gak"><%= data.members[i].HERO_CHO%></span>
                                        <% } else{  %>
                                            <% let gak2eng = {1: "one", 2: "two", 0:"no"} %>
                                            <img src="/sources/img/characters/<%= data.members[i].TYPE%>_<%= data.members[i].NAME%>_<%= data.members[i].CLASS%>.png" onerror="this.onerror=null; this.src='/sources/img/characters/Chr_Error.png';" >
                                            <span class="lv_<%= data.members[i].TYPE%> lv"><%= data.members[i].HERO_LV%></span>
                                            <span class="<%= gak2eng[data.members[i].HERO_GAK]%>gak gak"><%= data.members[i].HERO_CHO%></span>
                                        <% } %>
                                    </div>
                                </div>
                            <% } %>
                        </div>
                        <h5 class="w-100">2 부대</h5>
                        <div class="form-char-container w-100 d-flex flex-wrap justify-content-center ">
                            <% for(let i=5; i<10; i++){ %>
                                <div class="character-10 form_spot">
                                    <div class="select-liner">
                                        <% if(data.members[i].NAME == 'empty'){ %>
                                            <div class="empty"><i class="fa-solid fa-plus color-gray"></i> </div>
                                        <% } else if(data.members[i].HERO_LV == 0){ %>
                                            <% let gak2eng = {1: "one", 2: "two", 0:"no"} %>
                                            <img src="/sources/img/characters/<%= data.members[i].TYPE%>_<%= data.members[i].NAME%>_<%= data.members[i].CLASS%>.png" class="nothave" onerror="this.onerror=null; this.src='/sources/img/characters/Chr_Error.png';" >
                                            <span class="lv_<%= data.members[i].TYPE%> lv"><%= data.members[i].HERO_LV%></span>
                                            <span class="<%= gak2eng[data.members[i].HERO_GAK]%>gak gak"><%= data.members[i].HERO_CHO%></span>
                                        <% } else{  %>
                                            <% let gak2eng = {1: "one", 2: "two", 0:"no"} %>
                                            <img src="/sources/img/characters/<%= data.members[i].TYPE%>_<%= data.members[i].NAME%>_<%= data.members[i].CLASS%>.png" onerror="this.onerror=null; this.src='/sources/img/characters/Chr_Error.png';" >
                                            <span class="lv_<%= data.members[i].TYPE%> lv"><%= data.members[i].HERO_LV%></span>
                                            <span class="<%= gak2eng[data.members[i].HERO_GAK]%>gak gak"><%= data.members[i].HERO_CHO%></span>
                                        <% } %>
                                    </div>
                                </div>
                            <% } %>
                            
                        </div>
                        <% } else if  (data.members.length == 7){  %>
                            <div class="form-char-container w-100 d-flex flex-wrap justify-content-center ">
                            <% for(let i=5; i<10; i++){ %>
                                <div class="character-7 form_spot">
                                    <div class="select-liner">
                                        <% if(data.members[i].NAME == 'empty'){ %>
                                            <div class="empty"><i class="fa-solid fa-plus color-gray"></i> </div>
                                        <% } else if(data.members[i].HERO_LV == 0){ %>
                                            <% let gak2eng = {1: "one", 2: "two", 0:"no"} %>
                                            <img src="/sources/img/characters/<%= data.members[i].TYPE%>_<%= data.members[i].NAME%>_<%= data.members[i].CLASS%>.png" class="nothave" onerror="this.onerror=null; this.src='/sources/img/characters/Chr_Error.png';" >
                                            <span class="lv_<%= data.members[i].TYPE%> lv"><%= data.members[i].HERO_LV%></span>
                                            <span class="<%= gak2eng[data.members[i].HERO_GAK]%>gak gak"><%= data.members[i].HERO_CHO%></span>
                                        <% } else{  %>
                                            <% let gak2eng = {1: "one", 2: "two", 0:"no"} %>
                                            <img src="/sources/img/characters/<%= data.members[i].TYPE%>_<%= data.members[i].NAME%>_<%= data.members[i].CLASS%>.png" onerror="this.onerror=null; this.src='/sources/img/characters/Chr_Error.png';" >
                                            <span class="lv_<%= data.members[i].TYPE%> lv"><%= data.members[i].HERO_LV%></span>
                                            <span class="<%= gak2eng[data.members[i].HERO_GAK]%>gak gak"><%= data.members[i].HERO_CHO%></span>
                                        <% } %>
                                    </div>
                                </div>
                                <% if(i == 2){ %>
                                <div class="change-line"></div>
                                <% } %>
                            <% } %>
                            
                            </div>
                         <% }%>

                    </form>
                    

                    <div class="left-box-bottom d-flex justify-content-start align-items-center">
                        <span class="view">조회수 <span><%=data.form_info[0].VIEW %></span></span>
                        <span class="mine"><i class="fa-solid fa-bookmark"></i> <%=data.form_info[0].SAVED_CNT %></span>
                        <!-- 복사 버튼 -->
                        <span class="share"><i class="fa-solid fa-share"></i></span>
                    </div>
                </div>

                <!-- 오른쪽 -->
                <div class="right-box">
                    <h6 class="explain-title d-flex align-items-end">작성자 한마디</h6>
                    <div class="bg-white memo-container color-gray">
                        <div class="memo explain-content"  ><%=data.form_info[0].WRITER_MEMO %></div>
                    </div>

                    <!-- 좋아요 / 댓글 펼치기 -->
                    <div class="btns mg-10px ms-0 me-0 d-flex flex-fill justify-content-between">
                        <div class="btn-shadow d-flex justify-content-between w-100">
                            <button class="edit btn-cut bottom-btn btn-blue color-white">수정 </button>
                            <button class="delete btn-cut bottom-btn btn-red color-white">삭제 </button>
                        </div>
                    </div>
                </div>

            </div>

        </div>
        <!-- 댓글 -->
        <div class="comments-container shadow-basic mypage-form-detail-sizing bg-gray">
            <div class="comment-header btn-black color-white">
                <span> 댓글 <span class="length ms-2"><%= data.comments.length + data.replys.length %></span> </span><i class="fa-solid fa-chevron-up"></i>
            </div>
            <div class="comment-body-container">
                <div class="comments blue-scroll">
                    <% let cnt=0 %>
                    <% for(let i=0; i<data.comments.length; i++){ %>
                    <!-- 댓글 하나 -->
                    <div class="comment" data-commentid="<%=data.comments[i].id %>">
                        <div class="comment-author bg-basicdark color-white">
                        <% if(data.comments[i].is_formauthor == 1) {%>
                            <span>작성자</span>
                        <% }%>
                        <% if(data.comments[i].nickname.includes("알 수 없음")){ %>
                            <span><%=data.comments[i].nickname %></span>
                        </div>
                        <% } else { %>    
                            <span class="color-purple"><%=data.comments[i].nickname %></span>
                        </div>
                        <% } %>    

                        <div class="comment-body w-100 d-flex">
                            <p><%=data.comments[i].comment_body %></p>
                        </div>

                        <% if(!data.comments[i].nickname.includes("알 수 없음")){ %>
                            <div class="comment-bottom d-flex">
                                <span class="date">
                                    <%=data.comments[i].last_datetime.getFullYear()+"-"+("0"+(data.comments[i].last_datetime.getMonth()+1)).slice(-2) + "-" + ("0"+(data.comments[i].last_datetime.getDate())).slice(-2) + " " +  ("0"+(data.comments[i].last_datetime.getHours())).slice(-2) + ":" +  ("0"+(data.comments[i].last_datetime.getMinutes())).slice(-2) %>
                                </span>
                                <span class="reply-btn">답글쓰기</span>
                                <% if(data.comments[i].is_author == 1) {%>
                                <div>
                                    <span class="edit">수정</span>
                                    <span class="delete color-red ms-1">삭제</span>
                                </div>
                                <% } else {%> 
                                    <div >
                                        <span class="color-red">신고</span>
                                    </div>
                                <% } %> 
                            </div>
                        <% } %>    
  
                        
                    </div>
                    <!-- 댓글 하나 끝 -->
                    <% while(cnt < data.replys.length && data.replys[cnt].comment_id == data.comments[i].id){ %>
                        <!-- 답글 하나 -->
                        <div class="reply" data-commentid="<%=data.replys[cnt].id %>">
                            <div class="comment-author bg-basicdark color-white">
                            <% if(data.replys[cnt].is_formauthor == 1) {%>
                                <span>작성자</span>
                            <% } %> 
                            <% if(data.replys[cnt].nickname.includes("알 수 없음")){ %>
                                <span><%=data.replys[cnt].nickname %></span>
                            </div>
                            <% } else { %>    
                                <span class="color-purple"><%=data.replys[cnt].nickname %></span>
                            </div>
                            <% } %>    
                            <div class="comment-body w-100 d-flex align-items-baseline">
                                <% if(data.replys[cnt].reply_id){ %>
                                    <span class="me-3 color-purple">@<%=data.replys[cnt].reply_nickanme %></span>
                                <% } %>
                                <p><%=data.replys[cnt].reply_body %> </p>
                                
                            </div>
                            
                            <% if(!data.replys[cnt].nickname.includes("알 수 없음")){ %>
                                <div class="comment-bottom d-flex">
                                    <span class="date">
                                        <%=data.replys[cnt].last_datetime.getFullYear()+"-"+("0"+(data.replys[cnt].last_datetime.getMonth()+1)).slice(-2) + "-" + ("0"+(data.replys[cnt].last_datetime.getDate())).slice(-2) + " " +  ("0"+(data.replys[cnt].last_datetime.getHours())).slice(-2) + ":" +  ("0"+(data.replys[cnt].last_datetime.getMinutes())).slice(-2) %>
                                    </span>
                                    
                                    <span class="reply-btn">답글쓰기</span>
                                    <% if(data.replys[cnt].is_author == 1) {%>
                                    <div>
                                        <span class="edit">수정</span>
                                        <span class="delete color-red ms-1">삭제</span>
                                    </div>
                                    <% } else {%> 
                                        <div >
                                            <span class="report color-red">신고</span>
                                        </div>
                                    <% } %> 
                                </div>
                            <% } %>    

                            
                        </div>
                        <!-- 답글 하나 끝 -->
                        <% cnt += 1 %>
                    <% } %>
                    <% } %>
                    
                </div>
                <form class="write-comment bg-white">
                    
                    <!-- 여기다 답하는 댓글 아이디 value로 저장 -->
                    <input type="hidden" name="reply_id" value="0">
                    <input type="hidden" name="kind" value="none">
                    <textarea name="comment" class="flex-fill blue-scroll" rows="1" id="comment" onkeyup="resize(this)" onkeydown="resize(this)" placeholder="내용을 입력하세요." ></textarea>
                    <div class="btn-shadow align-self-end">
                        <button type="submit" class="btn-cut btn-blue color-white border-0">전송</button>
                    </div>
                </form>
            </div>
            

        </div>

        <div class="near-link-container">
            <% if(data.previous[0]){ %>
            <a data-id="<%=data.previous[0].ID %>" data-rn="<%=data.previous[0].ORDER_NUM %>" class="d-flex near-link color-white shadow-basic mypage-form-detail-sizing bg-basicdark">
                    <% if (data.previous[0].STATUS_NAME == "편성 공유" ) { %>
                        <div class="status status-share">
                    <% } else if (data.previous[0].STATUS_NAME == "편성 요청" ) { %>
                        <div class="status status-request">
                    <% } else if (data.previous[0].STATUS_NAME == "편성 저장" ) { %>
                        <div class="status status-save">
                    <% } else if (data.previous[0].STATUS_NAME == "편성 도움" ) { %>
                        <div class="status status-help">
                    <% } else if (data.previous[0].STATUS_NAME == "편성 완료" ) { %>
                        <div class="status status-end">
                    <% } else { %>
                        <div class="status status-share">
                    <% } %>
                <%=data.previous[0].STATUS_NAME %></div>
                <div class="link-title flex-fill d-flex  align-items-center">
                    <span class="color-yellow flex-fill"><%=data.previous[0].CONTENT_NAME %></span>
                    <% if(data.previous[0].ACCESS == 'private') {%>
                        <i class="me-5 color-yellow fa-solid fa-lock"></i>
                    <% }%>
                    <span class="me-4">이전 편성</span>
                    <i class="fa-solid fa-chevron-up"></i>
                </div>
                
            </a>
            <% } %>

            <% if(data.next[0]){ %>
            <a data-id="<%=data.next[0].ID %>" data-rn="<%=data.next[0].ORDER_NUM %>" class="d-flex near-link color-white shadow-basic mypage-form-detail-sizing bg-basicdark">
                <% if (data.next[0].STATUS_NAME == "편성 공유" ) { %>
                        <div class="status status-share">
                    <% } else if (data.next[0].STATUS_NAME == "편성 요청" ) { %>
                        <div class="status status-request">
                    <% } else if (data.next[0].STATUS_NAME == "편성 저장" ) { %>
                        <div class="status status-save">
                    <% } else if (data.next[0].STATUS_NAME == "편성 도움" ) { %>
                        <div class="status status-help">
                    <% } else if (data.next[0].STATUS_NAME == "편성 완료" ) { %>
                        <div class="status status-end">
                    <% } else { %>
                        <div class="status status-share">
                    <% } %>
                <%=data.next[0].STATUS_NAME %></div>
                <div class="link-title flex-fill d-flex  align-items-center">
                    <span class="color-yellow flex-fill"><%=data.next[0].CONTENT_NAME %></span>
                    <% if(data.next[0].ACCESS == 'private') {%>
                        <i class="me-5 color-yellow fa-solid fa-lock"></i>
                    <% }%>
                    <span class="me-4">다음 편성</span>
                    <i class="fa-solid fa-chevron-down"></i>
                </div>
            </a>
            <% } %>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script> 
    <script src="/js/Comments.js"></script>
    <script>

        function resize(obj) {

                obj.style.height = 'auto';
                obj.style.height = obj.scrollHeight + 'px';
            
        }

        $(".mypage-remote .go-back").on("click", function(e){
            e.preventDefault();


            let id = $(this).data('id');
            let new_url = `/mypage/formsave${location.search}`
            window.location.href = new_url;
        })

        $(".comment-header").on("click", function(){
            $(this).children("i").toggleClass("fa-chevron-up");
            $(this).children("i").toggleClass("fa-chevron-down");
            $(this).siblings(".comment-body-container").slideToggle();
        })

        $(".near-link-container a").on("click", function(e){
            e.preventDefault();

            let url = new URL(window.location.href);
            url.searchParams.set("n", $(this).data('rn'));

            let id = $(this).data('id');
            let new_url = `/mypage/formsave/detail/${id}?${url.searchParams.toString()}`
            window.location.href = new_url;
        })

        $(".left-box-bottom .share").on("click", function(e){
            var urlinput = $("<input type='text'>")
            urlinput.val(window.location.host + '/forum/detail/' + $(".form-container").data("id") + window.location.search)
            urlinput.appendTo('body');
            
            urlinput.select();
            var success = document.execCommand("copy");
            urlinput.remove();
            if(success){
                $('.toast-black').text("공유 링크가 클립보드에 복사되었습니다.").fadeIn(600).delay(1500).fadeOut(600);
            }
        })

        // 폼 삭제
        $(".right-box .delete").on("click", function(e){
            e.preventDefault();
            let ans = confirm("편성을 삭제하시겠습니까? 이 동작은 되돌릴 수 없습니다.")
            if(ans){
                let form = $("<form> </form>");
                form.attr("method", "post");
                form.attr("action", `/forum/delete/form/${window.location.pathname.split("/").pop()}`);
                form.append("<input type='input'  name='page' value='mypage'>")
                form.appendTo("body");
                form.submit();
            }
            
        })

        $(".right-box .edit").on("click", function(e){
            e.preventDefault();
            if($(".form-status p").text() == "편성 저장"){
                if(!confirm("[편성 저장]은 수정하면 자신의 [편성 공유] 상태로 저장됩니다. 계속하시겠습니까?"))
                    return;
            }
            
            window.location.href = `/formmake/edit/${window.location.pathname.split("/").pop()}`
            
        })

        $(document).on("click", ".comment-bottom .reply-btn", function(e){
            if($(this).text() == "답글쓰기" && $(this).parent().parent().hasClass("comment")){
                $(".write-comment").prepend(`<div class="comment-author  bg-basicdark color-white">
                                            <span class="color-purple">${$(this).parent().siblings(".comment-author").children(".color-purple").text()}</span> <span>답글</span> 
                                        </div>`);
                $(".write-comment input[name='reply_id']").val($(this).parent().parent().data("commentid"));
                $(".write-comment input[name='kind']").val('comment');
                $(this).text("답글취소").addClass("color-red");
                $(".write-comment textarea").focus();
            }else if($(this).text() == "답글쓰기" && $(this).parent().parent().hasClass("reply")){
                $(".write-comment").prepend(`<div class="comment-author  bg-basicdark color-white">
                                            <span class="color-purple">${$(this).parent().siblings(".comment-author").children(".color-purple").text()}</span> <span>답글</span> 
                                        </div>`);
                $(".write-comment input[name='reply_id']").val($(this).parent().parent().data("commentid"));
                $(".write-comment input[name='kind']").val('reply');
                $(this).text("답글취소").addClass("color-red");
                $(".write-comment textarea").focus();
            }else{
                $(".write-comment .comment-author").remove();
                $(".write-comment input[name='reply_id']").val('0');
                $(".write-comment input[name='kind']").val('none');
                $(this).text("답글쓰기").removeClass("color-red");
            }
        })

        

        $(document).ready(function(){
            $(".write-comment").on("submit", function(e){
                e.preventDefault();

                const query = $('.write-comment').serializeArray();

                $.ajax({
                        url: `/forum/submit/comment/${window.location.pathname.split("/").pop()}`, 
                        method: 'POST', 
                        contentType: 'application/json',
                        data: JSON.stringify({ 
                            reply_id : query[0].value,
                            kind : query[1].value,
                            comment : query[2].value,
                        }),
                        
                        // 요청 성공 
                        success: function(res) {
                            if(res.status.includes('2')){
                                // 댓글 다시 출력
                                commentsReload(res.data.comments, res.data.replys)
                                $("textarea").val("");
                                $(".write-comment .comment-author").remove();

                                // hidden input value 초기화
                                $(".write-comment input[name='reply_id']").val("0");
                                $(".write-comment input[name='kind']").val("none");
                            } else{
                                // DB 오류
                                alert(res.message);
                            }
                        },                        
                        
                        error: function(xhr, status, error) {
                            // 오류 
                            alert(`오류 발생! 다시 시도하세요. ${status} - ${error}`);
                            console.error('Error:', status, error);
                        }
                    })
            })

            $(document).on("click", ".comment-bottom .edit", function(e){
                if($(this).text() == "수정"){
                    let txt = $(this).parent().parent().siblings(".comment-body").children('p').text();
                    $(this).parent().parent().siblings(".comment-body").children('p').css("display", "none");
                    $(this).parent().parent().siblings(".comment-body").append(`
                    <textarea  name="comment" class="bg-white flex-fill blue-scroll" rows="1" >${txt}</textarea>
                    <button type="button" class="update-btn btn-cut btn-blue color-white border-0">수정</button>
                    `)
                    $(".comment-body textarea").focus();
                    $(this).text("수정취소").addClass("color-red").removeClass("color-black");
                } else{
                    let txt = $(this).parent().parent().siblings(".comment-body").children('textarea').val();
                    $(this).parent().parent().siblings(".comment-body").children('textarea').remove();
                    $(this).parent().parent().siblings(".comment-body").children('button').remove();
                    $(this).parent().parent().siblings(".comment-body").children('p').css("display", "block");
                    $(this).text("수정").addClass("color-black").removeClass("color-red");
                }

            })

            $(document).on("click", ".comment-body .update-btn", function(e){
                e.preventDefault();
                
                $.ajax({
                        url: `/forum/edit/comment/${window.location.pathname.split("/").pop()}`, 
                        method: 'POST', 
                        contentType: 'application/json',
                        data: JSON.stringify({ 
                            id : $(this).parent().parent().data("commentid"),
                            kind : $(this).parent().parent().attr("class"),
                            comment : $(this).siblings("textarea").val(),
                        }),
                        
                        // 요청 성공 
                        success: function(res) {
                            if(res.status.includes('2')){
                                // 댓글 다시 출력
                                commentsReload(res.data.comments, res.data.replys)
                                let txt = $(this).parent().parent().siblings(".comment-body").children('textarea').val();
                                $(this).siblings('p').css("display", "block");
                                $(this).siblings('textarea').remove();
                                $(".comment-bottom .edit").text("수정").addClass("color-black").removeClass("color-red");
                                $(this).remove();
                                $('.toast-black').text("댓글 수정이 완료되었습니다.").fadeIn(600).delay(1500).fadeOut(600);
                            } else{
                                // DB 오류
                                alert(res.message);
                            }
                        },                        
                        
                        error: function(xhr, status, error) {
                            // 오류 
                            alert(`오류 발생! 다시 시도하세요. ${status} - ${error}`);
                            console.error('Error:', status, error);
                        }
                    })
            })

            $(document).on("click", ".comment-bottom .delete", function(e){
                var ans = confirm("정말 삭제하시겠습니까? 삭제한 댓글은 되돌릴 수 없습니다.");

                if(ans){
                    $.ajax({
                        url: `/forum/delete/comment/${window.location.pathname.split("/").pop()}`, 
                        method: 'POST', 
                        contentType: 'application/json',
                        data: JSON.stringify({ 
                            id : $(this).parent().parent().parent().data("commentid"),
                            kind : $(this).parent().parent().parent().attr("class"),
                        }),
                        
                        // 요청 성공 
                        success: function(res) {
                            if(res.status.includes('2')){
                                // 댓글 다시 출력
                                commentsReload(res.data.comments, res.data.replys)
                                $('.toast-black').text("댓글 삭제가 완료되었습니다.").fadeIn(600).delay(1500).fadeOut(600);
                            } else{
                                // DB 오류
                                alert(res.message);
                            }
                        },                        
                        
                        error: function(xhr, status, error) {
                            // 오류 
                            alert(`오류 발생! 다시 시도하세요. ${status} - ${error}`);
                            console.error('Error:', status, error);
                        }
                    })
                }

            })
        })


        
    </script>
</body>
</html>